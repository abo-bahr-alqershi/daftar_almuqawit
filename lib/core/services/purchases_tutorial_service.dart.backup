import 'dart:math';
import 'package:flutter/material.dart';
import 'package:tutorial_coach_mark/tutorial_coach_mark.dart';
import '../theme/app_colors.dart';

/// Ø®Ø¯Ù…Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ù…Ø­Ø³Ù†Ø© Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
class PurchasesTutorialService {
  static TutorialCoachMark? _tutorial;

  /// Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ Ù„Ù„Ù…Ø­ØªÙˆÙ‰ Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¯Ù‚ÙŠÙ‚Ø© ÙˆØ§Ø­ØªØ±Ø§ÙÙŠØ© Ø´Ø§Ù…Ù„Ø©
  static CustomTargetContentPosition _calculatePosition({
    required BuildContext context,
    required GlobalKey targetKey,
    required double contentHeight,
  }) {
    try {
      final renderBox =
          targetKey.currentContext?.findRenderObject() as RenderBox?;
      if (renderBox == null) {
        debugPrint('âš ï¸ RenderBox is null, using fallback position');
        return CustomTargetContentPosition(top: 120);
      }

      final targetPosition = renderBox.localToGlobal(Offset.zero);
      final targetSize = renderBox.size;
      final screenHeight = MediaQuery.of(context).size.height;
      final screenWidth = MediaQuery.of(context).size.width;
      final safeAreaTop = MediaQuery.of(context).padding.top;
      final safeAreaBottom = MediaQuery.of(context).padding.bottom;
      final keyboardHeight = MediaQuery.of(context).viewInsets.bottom;

      final targetTop = targetPosition.dy;
      final targetBottom = targetPosition.dy + targetSize.height;
      final targetHeight = targetSize.height;
      final targetLeft = targetPosition.dx;

      // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…ØªØ§Ø­Ø© Ø§Ù„ÙØ¹Ù„ÙŠØ© Ù…Ø¹ Ù‡Ø§Ù…Ø´ Ø£Ù…Ø§Ù†
      final safetyMargin = 15.0;
      final usableScreenTop = safeAreaTop + safetyMargin;
      final usableScreenBottom =
          screenHeight - keyboardHeight - safeAreaBottom - safetyMargin;
      final usableHeight = usableScreenBottom - usableScreenTop;

      final spaceAbove = targetTop - usableScreenTop;
      final spaceBelow = usableScreenBottom - targetBottom;
      final totalAvailableSpace = spaceAbove + spaceBelow;

      debugPrint('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
      debugPrint('ğŸ¯ Target Analysis:');
      debugPrint(
        '   Position: top=$targetTop, bottom=$targetBottom, left=$targetLeft',
      );
      debugPrint('   Size: width=${targetSize.width}, height=$targetHeight');
      debugPrint('ğŸ“± Screen Info:');
      debugPrint('   Total height=$screenHeight, width=$screenWidth');
      debugPrint(
        '   Keyboard=$keyboardHeight, SafeTop=$safeAreaTop, SafeBottom=$safeAreaBottom',
      );
      debugPrint('ğŸ“ Space Analysis:');
      debugPrint('   Above target: $spaceAbove px');
      debugPrint('   Below target: $spaceBelow px');
      debugPrint('   Content needs: $contentHeight px');
      debugPrint('   Total available: $totalAvailableSpace px');
      debugPrint(
        '   Usable area: $usableScreenTop â†’ $usableScreenBottom ($usableHeight px)',
      );

      // Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø°ÙƒÙŠØ© Ù…Ø­Ø³Ù†Ø© Ù…ØªØ¹Ø¯Ø¯Ø© Ø§Ù„Ù…Ø±Ø§Ø­Ù„:

      // Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1: Ù‡Ù„ ÙŠÙˆØ¬Ø¯ Ù…Ø³Ø§Ø­Ø© ÙƒØ§ÙÙŠØ© Ø£Ø³ÙÙ„ Ø§Ù„Ø¹Ù†ØµØ±ØŸ (Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…ÙØ¶Ù„)
      if (spaceBelow >= contentHeight + 30) {
        final position = (targetBottom + 12).clamp(
          usableScreenTop,
          usableScreenBottom - contentHeight,
        );
        debugPrint(
          'âœ… Strategy: BELOW - Enough space (${spaceBelow.toStringAsFixed(0)} px)',
        );
        debugPrint('   Content at: $position px (clamped to safe area)');
        debugPrint('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        return CustomTargetContentPosition(top: position);
      }

      // Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2: Ù‡Ù„ ÙŠÙˆØ¬Ø¯ Ù…Ø³Ø§Ø­Ø© ÙƒØ§ÙÙŠØ© Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†ØµØ±ØŸ
      if (spaceAbove >= contentHeight + 30) {
        final position = (targetTop - contentHeight - 12).clamp(
          usableScreenTop,
          usableScreenBottom - contentHeight,
        );
        debugPrint(
          'âœ… Strategy: ABOVE - Enough space (${spaceAbove.toStringAsFixed(0)} px)',
        );
        debugPrint('   Content at: $position px (clamped to safe area)');
        debugPrint('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        return CustomTargetContentPosition(top: position);
      }

      // Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3: Ù…Ø¹Ø§Ù„Ø¬Ø© Ø°ÙƒÙŠØ© Ù„Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø­Ø¯ÙˆØ¯Ø©
      debugPrint('âš ï¸ Limited space - Using smart positioning...');

      final belowRatio = totalAvailableSpace > 0
          ? spaceBelow / totalAvailableSpace
          : 0;
      final aboveRatio = totalAvailableSpace > 0
          ? spaceAbove / totalAvailableSpace
          : 0;

      debugPrint(
        '   Space ratio - Below: ${(belowRatio * 100).toStringAsFixed(1)}%, Above: ${(aboveRatio * 100).toStringAsFixed(1)}%',
      );

      // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø£Ø³ÙÙ„ Ø£ÙƒØ¨Ø± Ø£Ùˆ Ù…ØªØ³Ø§ÙˆÙŠØ©ØŒ Ù†ÙØ¶Ù„Ù‡Ø§
      if (spaceBelow >= spaceAbove) {
        final idealPosition = targetBottom + 10;
        final position = idealPosition.clamp(
          usableScreenTop,
          usableScreenBottom - contentHeight,
        );

        debugPrint(
          'âœ… Strategy: BELOW (constrained) - ${spaceBelow.toStringAsFixed(0)} px available',
        );
        debugPrint('   Ideal: $idealPosition, Final: $position (clamped)');
        debugPrint('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        return CustomTargetContentPosition(top: position);
      }

      // Ø§Ù„Ù…Ø±Ø­Ù„Ø© 4: Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø£Ø¹Ù„Ù‰ Ø£ÙƒØ¨Ø±
      final idealPosition = targetTop - contentHeight - 10;
      final position = idealPosition.clamp(
        usableScreenTop,
        usableScreenBottom - contentHeight,
      );

      debugPrint(
        'âœ… Strategy: ABOVE (constrained) - ${spaceAbove.toStringAsFixed(0)} px available',
      );
      debugPrint('   Ideal: $idealPosition, Final: $position (clamped)');
      debugPrint('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
      return CustomTargetContentPosition(top: position);
    } catch (e) {
      debugPrint('âŒ Error calculating position: $e');
      debugPrint('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
      return CustomTargetContentPosition(top: 120);
    }
  }

  /// ØªÙ…Ø±ÙŠØ± Ø§Ø³ØªØ¨Ø§Ù‚ÙŠ Ø°ÙƒÙŠ Ù…Ø­Ø³Ù‘Ù† Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆÙ‡Ø§Øª
  static Future<void> _preScroll({
    required BuildContext context,
    required GlobalKey targetKey,
    required ScrollController? scrollController,
    required double contentHeight,
  }) async {
    if (scrollController == null || !scrollController.hasClients) {
      debugPrint('âš ï¸ No scroll controller available');
      return;
    }

    try {
      final renderBox =
          targetKey.currentContext?.findRenderObject() as RenderBox?;
      if (renderBox == null) {
        debugPrint('âš ï¸ RenderBox not available for scroll calculation');
        return;
      }

      final targetPosition = renderBox.localToGlobal(Offset.zero);
      final targetSize = renderBox.size;
      final screenHeight = MediaQuery.of(context).size.height;
      final safeAreaTop = MediaQuery.of(context).padding.top;
      final safeAreaBottom = MediaQuery.of(context).padding.bottom;
      final keyboardHeight = MediaQuery.of(context).viewInsets.bottom;

      final elementTop = targetPosition.dy;
      final elementBottom = targetPosition.dy + targetSize.height;
      final elementHeight = targetSize.height;
      final currentScrollOffset = scrollController.offset;

      // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø«Ø§Ù„ÙŠØ© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù†ØµØ± Ù…Ø¹ Ù‡Ø§Ù…Ø´ Ø£Ù…Ø§Ù† Ù…Ø­Ø³Ù‘Ù†
      final topMargin = 100.0;
      final bottomMargin = contentHeight + 100;

      final usableScreenTop = safeAreaTop + topMargin;
      final usableScreenBottom =
          screenHeight - keyboardHeight - safeAreaBottom - bottomMargin;
      final usableHeight = usableScreenBottom - usableScreenTop;

      debugPrint('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
      debugPrint('ğŸ“œ Pre-Scroll Analysis (Enhanced):');
      debugPrint(
        '   Element: top=$elementTop, bottom=$elementBottom, height=$elementHeight',
      );
      debugPrint('   Current scroll: $currentScrollOffset');
      debugPrint(
        '   Usable area: $usableScreenTop â†’ $usableScreenBottom ($usableHeight px)',
      );
      debugPrint('   Content needs: $contentHeight px + margins');

      double scrollDelta = 0;
      String strategy = '';

      // Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ù…Ø­Ø³Ù‘Ù†Ø© Ù„Ù„ØªÙ…Ø±ÙŠØ±:

      // Ø§Ù„Ø­Ø§Ù„Ø© 1: Ø§Ù„Ø¹Ù†ØµØ± ÙÙˆÙ‚ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø«Ø§Ù„ÙŠØ©
      if (elementTop < usableScreenTop) {
        scrollDelta = elementTop - usableScreenTop - 40;
        strategy = 'SCROLL UP - Element too high';
        debugPrint('â¬†ï¸ $strategy');
        debugPrint('   Element at $elementTop, target at $usableScreenTop');
      }
      // Ø§Ù„Ø­Ø§Ù„Ø© 2: Ø§Ù„Ø¹Ù†ØµØ± Ø£Ùˆ Ù†Ù‡Ø§ÙŠØªÙ‡ ØªØ­Øª Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø«Ø§Ù„ÙŠØ©
      else if (elementBottom > usableScreenBottom) {
        // Ù†Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ù†ØµØ± ÙÙŠ Ù…ÙˆØ¶Ø¹ Ù…Ø«Ø§Ù„ÙŠ
        scrollDelta = elementTop - usableScreenTop - 40;
        strategy = 'SCROLL DOWN - Element too low (CRITICAL)';
        debugPrint('â¬‡ï¸ $strategy');
        debugPrint(
          '   Element bottom at $elementBottom, usable bottom at $usableScreenBottom',
        );
        debugPrint('   Required scroll: $scrollDelta px');
      }
      // Ø§Ù„Ø­Ø§Ù„Ø© 3: Ø§Ù„Ø¹Ù†ØµØ± ÙÙŠ Ø§Ù„Ù…ÙˆØ¶Ø¹ Ø§Ù„ØµØ­ÙŠØ­ - Ù†ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ù…Ø­ØªÙˆÙ‰
      else {
        final spaceBelow =
            screenHeight - elementBottom - keyboardHeight - safeAreaBottom;
        final spaceAbove = elementTop - safeAreaTop;

        debugPrint('   Space check: below=$spaceBelow, above=$spaceAbove');

        // Ø¥Ø°Ø§ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³Ø§Ø­Ø© ÙƒØ§ÙÙŠØ© Ù„Ù„Ù…Ø­ØªÙˆÙ‰
        if (spaceBelow < contentHeight + 40) {
          // Ø­Ø§ÙˆÙ„ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³Ø§Ø­Ø© Ø¨ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø¹Ù†ØµØ± Ù„Ù„Ø£Ø¹Ù„Ù‰
          scrollDelta = max(
            (contentHeight + 50 - spaceBelow) * 0.7,
            elementTop - usableScreenTop - 40,
          );
          strategy = 'FINE TUNE - Creating space below';
          debugPrint('ğŸ”§ $strategy');
          debugPrint(
            '   Need ${contentHeight + 40} px, have $spaceBelow below',
          );
          debugPrint('   Calculated delta: $scrollDelta px');
        } else {
          strategy = 'NO SCROLL - Element in optimal position';
          debugPrint('âœ… $strategy');
        }
      }

      // ØªÙ†ÙÙŠØ° Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø­Ø³Ù‘Ù†Ø©
      if (scrollDelta.abs() > 10) {
        final minScroll = scrollController.position.minScrollExtent;
        final maxScroll = scrollController.position.maxScrollExtent;
        final targetOffset = (currentScrollOffset + scrollDelta).clamp(
          minScroll,
          maxScroll,
        );

        // ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù…Ù…ÙƒÙ† ÙˆÙ…ÙÙŠØ¯
        final actualDelta = (targetOffset - currentScrollOffset).abs();
        if (actualDelta > 5) {
          debugPrint('ğŸ“ Executing scroll:');
          debugPrint('   From: $currentScrollOffset â†’ To: $targetOffset');
          debugPrint('   Delta: ${targetOffset - currentScrollOffset}');
          debugPrint('   Bounds: min=$minScroll, max=$maxScroll');

          await scrollController.animateTo(
            targetOffset,
            duration: const Duration(milliseconds: 450),
            curve: Curves.easeInOutCubic,
          );

          // Ø§Ù†ØªØ¸Ø§Ø± Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ø§Ù„ØªÙ…Ø±ÙŠØ±
          await Future.delayed(const Duration(milliseconds: 250));

          debugPrint('âœ… Scroll animation completed');
        } else {
          debugPrint('âš ï¸ Scroll delta too small ($actualDelta px), skipping');
        }
      }

      debugPrint('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    } catch (e, stackTrace) {
      debugPrint('âŒ Error in pre-scroll: $e');
      debugPrint('Stack trace: $stackTrace');
      debugPrint('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    }
  }

  /// ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ© Ø´Ø±Ø§Ø¡ (Ù…Ø­Ø¯Ù‘Ø«Ø© Ù…Ø¹ Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©)
  static Future<void> showAddTutorial({
    required BuildContext context,
    required GlobalKey invoiceNumberFieldKey,
    required GlobalKey supplierFieldKey,
    required GlobalKey dateFieldKey,
    required GlobalKey qatTypeFieldKey,
    required GlobalKey quantityFieldKey,
    required GlobalKey unitFieldKey,
    required GlobalKey priceFieldKey,
    required GlobalKey paymentMethodKey,
    required GlobalKey paidAmountKey,
    required GlobalKey saveButtonKey,
    required VoidCallback onNext,
    ScrollController? scrollController,
  }) async {
    await Future.delayed(const Duration(milliseconds: 300));

    const contentHeight = 235.0; // Ù…Ø­Ø³Ù‘Ù† Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø§Ø´Ø§Øª

    await _preScroll(
      context: context,
      targetKey: invoiceNumberFieldKey,
      scrollController: scrollController,
      contentHeight: contentHeight,
    );

    final targetKeys = [
      invoiceNumberFieldKey,
      supplierFieldKey,
      dateFieldKey,
      qatTypeFieldKey,
      quantityFieldKey,
      unitFieldKey,
      priceFieldKey,
      paymentMethodKey,
      paidAmountKey,
      saveButtonKey,
    ];

    final targets = <TargetFocus>[];

    // Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
    targets.add(
      TargetFocus(
        identify: 'invoice_number_field',
        keyTarget: invoiceNumberFieldKey,
        shape: ShapeLightFocus.RRect,
        radius: 12,
        paddingFocus: 8,
        contents: [
          TargetContent(
            align: ContentAlign.custom,
            customPosition: _calculatePosition(
              context: context,
              targetKey: invoiceNumberFieldKey,
              contentHeight: contentHeight,
            ),
            builder: (context, controller) {
              return _buildStepContent(
                context: context,
                stepNumber: 1,
                totalSteps: 10,
                title: 'Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ',
                description:
                    'Ø±Ù‚Ù… ØªØ³Ù„Ø³Ù„ÙŠ ÙŠÙÙˆÙ„Ù‘Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„ÙƒÙ„ Ø¹Ù…Ù„ÙŠØ© Ø´Ø±Ø§Ø¡\nÙŠØ³Ø§Ø¹Ø¯ ÙÙŠ ØªØªØ¨Ø¹ ÙˆØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø¨Ø¯Ù‚Ø©',
                onNext: () async {
                  await _preScroll(
                    context: context,
                    targetKey: targetKeys[1],
                    scrollController: scrollController,
                    contentHeight: contentHeight,
                  );
                  controller.next();
                },
                showSkip: true,
                onSkip: () => controller.skip(),
              );
            },
          ),
        ],
      ),
    );

    // Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ±Ø¯
    targets.add(
      TargetFocus(
        identify: 'supplier_field',
        keyTarget: supplierFieldKey,
        shape: ShapeLightFocus.RRect,
        radius: 10,
        contents: [
          TargetContent(
            align: ContentAlign.custom,
            customPosition: _calculatePosition(
              context: context,
              targetKey: supplierFieldKey,
              contentHeight: contentHeight,
            ),
            builder: (context, controller) {
              return _buildStepContent(
                context: context,
                stepNumber: 2,
                totalSteps: 10,
                title: 'Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ±Ø¯',
                description:
                    'Ø­Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ±Ø¯ Ø§Ù„Ø°ÙŠ ØªØ´ØªØ±ÙŠ Ù…Ù†Ù‡ Ø§Ù„Ù‚Ø§Øª\nÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ù…ÙˆØ±Ø¯ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…',
                onNext: () async {
                  await _preScroll(
                    context: context,
                    targetKey: targetKeys[2],
                    scrollController: scrollController,
                    contentHeight: contentHeight,
                  );
                  controller.next();
                },
                onPrevious: () async {
                  await _preScroll(
                    context: context,
                    targetKey: targetKeys[0],
                    scrollController: scrollController,
                    contentHeight: contentHeight,
                  );
                  controller.previous();
                },
                showSkip: true,
                onSkip: () => controller.skip(),
              );
            },
          ),
        ],
      ),
    );

    // Ø§Ù„Ø®Ø·ÙˆØ© 3: ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø±Ø§Ø¡
    targets.add(
      TargetFocus(
        identify: 'date_field',
        keyTarget: dateFieldKey,
        shape: ShapeLightFocus.RRect,
        radius: 10,
        contents: [
          TargetContent(
            align: ContentAlign.custom,
            customPosition: _calculatePosition(
              context: context,
              targetKey: dateFieldKey,
              contentHeight: contentHeight,
            ),
            builder: (context, controller) {
              return _buildStepContent(
                context: context,
                stepNumber: 3,
                totalSteps: 10,
                title: 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø±Ø§Ø¡',
                description:
                    'Ø­Ø¯Ø¯ ØªØ§Ø±ÙŠØ® Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø´Ø±Ø§Ø¡\nÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø®ØªÙŠØ§Ø± ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… Ø£Ùˆ ØªØ§Ø±ÙŠØ® Ø³Ø§Ø¨Ù‚',
                onNext: () async {
                  await _preScroll(
                    context: context,
                    targetKey: targetKeys[3],
                    scrollController: scrollController,
                    contentHeight: contentHeight,
                  );
                  controller.next();
                },
                onPrevious: () async {
                  await _preScroll(
                    context: context,
                    targetKey: targetKeys[1],
                    scrollController: scrollController,
                    contentHeight: contentHeight,
                  );
                  controller.previous();
                },
                showSkip: true,
                onSkip: () => controller.skip(),
              );
            },
          ),
        ],
      ),
    );

    // Ø§Ù„Ø®Ø·ÙˆØ© 4: Ù†ÙˆØ¹ Ø§Ù„Ù‚Ø§Øª
    targets.add(
      TargetFocus(
        identify: 'qat_type_field',
        keyTarget: qatTypeFieldKey,
        shape: ShapeLightFocus.RRect,
        radius: 10,
        contents: [
          TargetContent(
            align: ContentAlign.custom,
            customPosition: _calculatePosition(
              context: context,
              targetKey: qatTypeFieldKey,
              contentHeight: contentHeight,
            ),
            builder: (context, controller) {
              return _buildStepContent(
                context: context,
                stepNumber: 4,
                totalSteps: 10,
                title: 'Ù†ÙˆØ¹ Ø§Ù„Ù‚Ø§Øª',
                description:
                    'Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù‚Ø§Øª Ø§Ù„Ø°ÙŠ ØªÙ… Ø´Ø±Ø§Ø¤Ù‡\nÙŠØ¸Ù‡Ø± Ø§Ø³Ù… Ø§Ù„Ù†ÙˆØ¹ ÙˆØ¯Ø±Ø¬Ø© Ø¬ÙˆØ¯ØªÙ‡',
                onNext: () async {
                  await _preScroll(
                    context: context,
                    targetKey: targetKeys[4],
                    scrollController: scrollController,
                    contentHeight: contentHeight,
                  );
                  controller.next();
                },
                onPrevious: () async {
                  await _preScroll(
                    context: context,
                    targetKey: targetKeys[2],
                    scrollController: scrollController,
                    contentHeight: contentHeight,
                  );
                  controller.previous();
                },
                showSkip: true,
                onSkip: () => controller.skip(),
              );
            },
          ),
        ],
      ),
    );

    // Ø§Ù„Ø®Ø·ÙˆØ© 5: Ø§Ù„ÙƒÙ…ÙŠØ©
    targets.add(
      TargetFocus(
        identify: 'quantity_field',
        keyTarget: quantityFieldKey,
        shape: ShapeLightFocus.RRect,
        radius: 10,
        contents: [
          TargetContent(
            align: ContentAlign.custom,
            customPosition: _calculatePosition(
              context: context,
              targetKey: quantityFieldKey,
              contentHeight: contentHeight,
            ),
            builder: (context, controller) {
              return _buildStepContent(
                context: context,
                stepNumber: 5,
                totalSteps: 10,
                title: 'ÙƒÙ…ÙŠØ© Ø§Ù„Ø´Ø±Ø§Ø¡',
                description: 'Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø´ØªØ±Ø§Ø©\nÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø±Ù‚Ù… Ù…ÙˆØ¬Ø¨',
                onNext: () async {
                  await _preScroll(
                    context: context,
                    targetKey: targetKeys[5],
                    scrollController: scrollController,
                    contentHeight: contentHeight,
                  );
                  controller.next();
                },
                onPrevious: () async {
                  await _preScroll(
                    context: context,
                    targetKey: targetKeys[3],
                    scrollController: scrollController,
                    contentHeight: contentHeight,
                  );
                  controller.previous();
                },
                showSkip: true,
                onSkip: () => controller.skip(),
              );
            },
          ),
        ],
      ),
    );

    // Ø§Ù„Ø®Ø·ÙˆØ© 6: Ø§Ù„ÙˆØ­Ø¯Ø©
    targets.add(
      TargetFocus(
        identify: 'unit_field',
        keyTarget: unitFieldKey,
        shape: ShapeLightFocus.RRect,
        radius: 10,
        contents: [
          TargetContent(
            align: ContentAlign.custom,
            customPosition: _calculatePosition(
              context: context,
              targetKey: unitFieldKey,
              contentHeight: contentHeight,
            ),
            builder: (context, controller) {
              return _buildStepContent(
                context: context,
                stepNumber: 6,
                totalSteps: 10,
                title: 'ÙˆØ­Ø¯Ø© Ø§Ù„Ù‚ÙŠØ§Ø³',
                description:
                    'Ø§Ø®ØªØ± ÙˆØ­Ø¯Ø© Ø§Ù„Ù‚ÙŠØ§Ø³ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©\n(Ø±Ø¨Ø·Ø©ØŒ ÙƒÙŠØ³ØŒ ÙƒØ±ØªÙˆÙ†ØŒ Ù‚Ø·Ø¹Ø©)',
                onNext: () async {
                  await _preScroll(
                    context: context,
                    targetKey: targetKeys[6],
                    scrollController: scrollController,
                    contentHeight: contentHeight,
                  );
                  controller.next();
                },
                onPrevious: () async {
                  await _preScroll(
                    context: context,
                    targetKey: targetKeys[4],
                    scrollController: scrollController,
                    contentHeight: contentHeight,
                  );
                  controller.previous();
                },
                showSkip: true,
                onSkip: () => controller.skip(),
              );
            },
          ),
        ],
      ),
    );

    // Ø§Ù„Ø®Ø·ÙˆØ© 7: Ø§Ù„Ø³Ø¹Ø±
    targets.add(
      TargetFocus(
        identify: 'price_field',
        keyTarget: priceFieldKey,
        shape: ShapeLightFocus.RRect,
        radius: 10,
        contents: [
          TargetContent(
            align: ContentAlign.custom,
            customPosition: _calculatePosition(
              context: context,
              targetKey: priceFieldKey,
              contentHeight: contentHeight,
            ),
            builder: (context, controller) {
              return _buildStepContent(
                context: context,
                stepNumber: 7,
                totalSteps: 10,
                title: 'Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©',
                description:
                    'Ø£Ø¯Ø®Ù„ Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„ÙˆØ§Ø­Ø¯Ø©\nØ³ÙŠØªÙ… Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹',
                onNext: () async {
                  await _preScroll(
                    context: context,
                    targetKey: targetKeys[7],
                    scrollController: scrollController,
                    contentHeight: contentHeight,
                  );
                  controller.next();
                },
                onPrevious: () async {
                  await _preScroll(
                    context: context,
                    targetKey: targetKeys[5],
                    scrollController: scrollController,
                    contentHeight: contentHeight,
                  );
                  controller.previous();
                },
                showSkip: true,
                onSkip: () => controller.skip(),
              );
            },
          ),
        ],
      ),
    );

    // Ø§Ù„Ø®Ø·ÙˆØ© 8: Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹
    targets.add(
      TargetFocus(
        identify: 'payment_method_field',
        keyTarget: paymentMethodKey,
        shape: ShapeLightFocus.RRect,
        radius: 12,
        paddingFocus: 10,
        enableOverlayTab: false,
        enableTargetTab: false,
        contents: [
          TargetContent(
            align: ContentAlign.custom,
            customPosition: _calculatePosition(
              context: context,
              targetKey: paymentMethodKey,
              contentHeight: contentHeight,
            ),
            padding: const EdgeInsets.symmetric(horizontal: 16),
            builder: (context, controller) {
              return _buildStepContent(
                context: context,
                stepNumber: 8,
                totalSteps: 10,
                title: 'Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹',
                description:
                    'Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©\n(Ù†Ù‚Ø¯ØŒ Ø¢Ø¬Ù„ØŒ Ø­ÙˆØ§Ù„Ø©ØŒ Ø£Ùˆ ØªØ­ÙˆÙŠÙ„)',
                onNext: () async {
                  debugPrint('ğŸ¯ Moving from step 8 to step 9');
                  await _preScroll(
                    context: context,
                    targetKey: targetKeys[8],
                    scrollController: scrollController,
                    contentHeight: contentHeight,
                  );
                  controller.next();
                },
                onPrevious: () async {
                  debugPrint('ğŸ¯ Moving from step 8 to step 7');
                  await _preScroll(
                    context: context,
                    targetKey: targetKeys[6],
                    scrollController: scrollController,
                    contentHeight: contentHeight,
                  );
                  controller.previous();
                },
                showSkip: true,
                onSkip: () => controller.skip(),
              );
            },
          ),
        ],
      ),
    );

    // Ø§Ù„Ø®Ø·ÙˆØ© 9: Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹
    targets.add(
      TargetFocus(
        identify: 'paid_amount_field',
        keyTarget: paidAmountKey,
        shape: ShapeLightFocus.RRect,
        radius: 10,
        contents: [
          TargetContent(
            align: ContentAlign.custom,
            customPosition: _calculatePosition(
              context: context,
              targetKey: paidAmountKey,
              contentHeight: contentHeight,
            ),
            builder: (context, controller) {
              return _buildStepContent(
                context: context,
                stepNumber: 9,
                totalSteps: 10,
                title: 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹',
                description:
                    'Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ ÙØ¹Ù„ÙŠØ§Ù‹\nÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† ÙƒØ§Ù…Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø£Ùˆ Ø¬Ø²Ø¡ Ù…Ù†Ù‡',
                onNext: () async {
                  await _preScroll(
                    context: context,
                    targetKey: targetKeys[9],
                    scrollController: scrollController,
                    contentHeight: contentHeight,
                  );
                  controller.next();
                },
                onPrevious: () async {
                  await _preScroll(
                    context: context,
                    targetKey: targetKeys[7],
                    scrollController: scrollController,
                    contentHeight: contentHeight,
                  );
                  controller.previous();
                },
                showSkip: true,
                onSkip: () => controller.skip(),
              );
            },
          ),
        ],
      ),
    );

    // Ø§Ù„Ø®Ø·ÙˆØ© 10: Ø²Ø± Ø§Ù„Ø­ÙØ¸
    targets.add(
      TargetFocus(
        identify: 'save_button',
        keyTarget: saveButtonKey,
        shape: ShapeLightFocus.RRect,
        radius: 12,
        contents: [
          TargetContent(
            align: ContentAlign.top,
            padding: const EdgeInsets.all(20),
            builder: (context, controller) {
              return _buildStepContent(
                context: context,
                stepNumber: 10,
                totalSteps: 10,
                title: 'Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©',
                description:
                    'Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ø­ÙØ¸ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø´Ø±Ø§Ø¡\nØªØ£ÙƒØ¯ Ù…Ù† Ø¯Ù‚Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸',
                onNext: () {
                  controller.skip();
                  onNext();
                },
                onPrevious: () async {
                  await _preScroll(
                    context: context,
                    targetKey: targetKeys[8],
                    scrollController: scrollController,
                    contentHeight: contentHeight,
                  );
                  controller.previous();
                },
                isLastStep: true,
                showSkip: false,
              );
            },
          ),
        ],
      ),
    );

    _tutorial = TutorialCoachMark(
      targets: targets,
      colorShadow: AppColors.textPrimary,
      opacityShadow: 0.90,
      paddingFocus: 2,
      alignSkip: Alignment.topLeft,
      textSkip: "ØªØ®Ø·ÙŠ",
      textStyleSkip: const TextStyle(
        color: Colors.white,
        fontSize: 16,
        fontWeight: FontWeight.w600,
      ),
      onFinish: () => _tutorial = null,
      onSkip: () {
        _tutorial = null;
        return true;
      },
    );

    _tutorial!.show(context: context, rootOverlay: true);
  }

  /// Ø¨Ù†Ø§Ø¡ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø®Ø·ÙˆØ© Ø¨ØªØµÙ…ÙŠÙ… Ù…Ø±Ù† ÙˆØ¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ Ù…Ø­Ø³Ù‘Ù†
  static Widget _buildStepContent({
    required BuildContext context,
    required int stepNumber,
    required int totalSteps,
    required String title,
    required String description,
    required VoidCallback onNext,
    VoidCallback? onPrevious,
    VoidCallback? onSkip,
    bool isLastStep = false,
    bool showSkip = false,
  }) {
    return LayoutBuilder(
      builder: (context, constraints) {
        final screenHeight = MediaQuery.of(context).size.height;
        final maxWidth = MediaQuery.of(context).size.width - 32;
        final contentWidth = maxWidth.clamp(300.0, 400.0);

        // ØªØ­Ø³ÙŠÙ† Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ Ù„Ù„Ø§Ø±ØªÙØ§Ø¹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø­Ø¬Ù… Ø§Ù„Ø´Ø§Ø´Ø©
        final dynamicMaxHeight = screenHeight < 700
            ? 280.0 // Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø©
            : screenHeight < 850
            ? 300.0 // Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„Ù…ØªÙˆØ³Ø·Ø©
            : 320.0; // Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø©

        return Container(
          width: contentWidth,
          constraints: BoxConstraints(
            minHeight: 180,
            maxHeight: dynamicMaxHeight,
          ),
          margin: const EdgeInsets.symmetric(horizontal: 16, vertical: 6),
          padding: const EdgeInsets.symmetric(horizontal: 18, vertical: 16),
          decoration: BoxDecoration(
            color: AppColors.surface,
            borderRadius: BorderRadius.circular(18),
            boxShadow: [
              BoxShadow(
                color: Colors.black.withValues(alpha: 0.25),
                blurRadius: 20,
                offset: const Offset(0, 8),
                spreadRadius: -4,
              ),
            ],
          ),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // Ù…Ø¤Ø´Ø± Ø§Ù„ØªÙ‚Ø¯Ù… - Ù…Ø¯Ù…Ø¬ ÙˆØ£ØµØºØ±
              Row(
                children: [
                  Container(
                    padding: const EdgeInsets.symmetric(
                      horizontal: 10,
                      vertical: 5,
                    ),
                    decoration: BoxDecoration(
                      gradient: const LinearGradient(
                        colors: [AppColors.primary, AppColors.success],
                      ),
                      borderRadius: BorderRadius.circular(16),
                    ),
                    child: Text(
                      'Ø§Ù„Ø®Ø·ÙˆØ© $stepNumber Ù…Ù† $totalSteps',
                      style: const TextStyle(
                        color: Colors.white,
                        fontSize: 11,
                        fontWeight: FontWeight.w700,
                      ),
                    ),
                  ),
                  const Spacer(),
                  if (showSkip && onSkip != null)
                    TextButton(
                      onPressed: onSkip,
                      style: TextButton.styleFrom(
                        padding: const EdgeInsets.symmetric(
                          horizontal: 6,
                          vertical: 2,
                        ),
                        minimumSize: const Size(45, 28),
                        tapTargetSize: MaterialTapTargetSize.shrinkWrap,
                      ),
                      child: const Text(
                        'ØªØ®Ø·ÙŠ',
                        style: TextStyle(
                          color: AppColors.textSecondary,
                          fontSize: 11,
                          fontWeight: FontWeight.w600,
                        ),
                      ),
                    ),
                ],
              ),
              const SizedBox(height: 12),

              // Ø§Ù„Ø¹Ù†ÙˆØ§Ù† - Ù…Ø¯Ù…Ø¬
              Row(
                children: [
                  Container(
                    padding: const EdgeInsets.all(7),
                    decoration: BoxDecoration(
                      color: AppColors.primary.withValues(alpha: 0.12),
                      borderRadius: BorderRadius.circular(9),
                    ),
                    child: Icon(
                      isLastStep
                          ? Icons.check_circle_rounded
                          : Icons.touch_app_rounded,
                      color: AppColors.primary,
                      size: 20,
                    ),
                  ),
                  const SizedBox(width: 10),
                  Expanded(
                    child: Text(
                      title,
                      style: const TextStyle(
                        fontSize: 16,
                        fontWeight: FontWeight.w800,
                        color: AppColors.textPrimary,
                        height: 1.2,
                      ),
                      maxLines: 2,
                      overflow: TextOverflow.ellipsis,
                    ),
                  ),
                ],
              ),
              const SizedBox(height: 10),

              // Ø§Ù„ÙˆØµÙ - Ù…Ø¹ ØªØ­ÙƒÙ… Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ Ø¨Ø§Ù„Ø§Ø±ØªÙØ§Ø¹
              Flexible(
                child: SingleChildScrollView(
                  physics: const BouncingScrollPhysics(),
                  child: Text(
                    description,
                    style: const TextStyle(
                      fontSize: 13,
                      color: AppColors.textSecondary,
                      height: 1.4,
                    ),
                    maxLines: 3,
                    overflow: TextOverflow.fade,
                  ),
                ),
              ),
              const SizedBox(height: 14),

              // Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… - Ù…Ø¯Ù…Ø¬Ø©
              Row(
                children: [
                  if (onPrevious != null)
                    Expanded(
                      child: OutlinedButton(
                        onPressed: onPrevious,
                        style: OutlinedButton.styleFrom(
                          side: const BorderSide(
                            color: AppColors.primary,
                            width: 1.5,
                          ),
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(11),
                          ),
                          padding: const EdgeInsets.symmetric(vertical: 10),
                          tapTargetSize: MaterialTapTargetSize.shrinkWrap,
                        ),
                        child: const Row(
                          mainAxisAlignment: MainAxisAlignment.center,
                          mainAxisSize: MainAxisSize.min,
                          children: [
                            Text(
                              'Ø§Ù„Ø³Ø§Ø¨Ù‚',
                              style: TextStyle(
                                color: AppColors.primary,
                                fontWeight: FontWeight.w700,
                                fontSize: 13,
                              ),
                            ),
                            SizedBox(width: 4),
                            Icon(
                              Icons.arrow_forward_rounded,
                              size: 15,
                              color: AppColors.primary,
                            ),
                          ],
                        ),
                      ),
                    ),
                  if (onPrevious != null) const SizedBox(width: 8),
                  Expanded(
                    flex: onPrevious != null ? 2 : 1,
                    child: ElevatedButton(
                      onPressed: onNext,
                      style: ElevatedButton.styleFrom(
                        backgroundColor: AppColors.primary,
                        foregroundColor: Colors.white,
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(11),
                        ),
                        padding: const EdgeInsets.symmetric(vertical: 10),
                        elevation: 3,
                        tapTargetSize: MaterialTapTargetSize.shrinkWrap,
                      ),
                      child: Row(
                        mainAxisAlignment: MainAxisAlignment.center,
                        mainAxisSize: MainAxisSize.min,
                        children: [
                          Text(
                            isLastStep ? 'ÙÙ‡Ù…Øª!' : 'Ø§Ù„ØªØ§Ù„ÙŠ',
                            style: const TextStyle(
                              fontWeight: FontWeight.w800,
                              fontSize: 14,
                            ),
                          ),
                          if (!isLastStep) ...[
                            const SizedBox(width: 5),
                            const Icon(Icons.arrow_back_rounded, size: 16),
                          ],
                        ],
                      ),
                    ),
                  ),
                ],
              ),
            ],
          ),
        );
      },
    );
  }

  static void dispose() {
    _tutorial = null;
  }
}
